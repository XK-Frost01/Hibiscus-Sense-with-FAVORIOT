{% extends 'base.html' %}
{% block title %}HOME PAGE{% endblock %}
{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% endblock %}
    {% block body %}
    <div class="content">
        {% if interface == False %}
            <h1>This is home page</h1>
        {% else %}
            <h1>There is an interface</h1>
            <div>
                <label for="parameterSelect">Choose a parameter:</label>
                <select id="parameterSelect">
                    <option value="">Select a parameter</option>
                    <option value="temperature">Temperature</option>
                    <option value="humidity">Humidity</option>
                    <option value="barometer">Barometer</option>
                    <option value="altitude">Altitude</option>
                </select>
            </div>
            <div>
                <h2>Data Table</h2>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in data_buffer %}
                            <tr>
                                <td>Timestamp</td>
                                <td>{{ data.timestamp }}</td>
                            </tr>
                            <tr>
                                <td>Temperature</td>
                                <td>{{ data.temperature }}</td>
                            </tr>
                            <tr>
                                <td>Humidity</td>
                                <td>{{ data.humidity }}</td>
                            </tr>
                            <tr>
                                <td>Barometer</td>
                                <td>{{ data.barometer }}</td>
                            </tr>
                            <tr>
                                <td>Altitude</td>
                                <td>{{ data.altitude }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                </table>
            </div>
            <div>
                <h2>Parameter Data Plot</h2>
                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div id="realtimeData"></div>
            <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
            <script>
                if (typeof io === 'undefined') {
                    document.write("<script src='{{ url_for('static', filename='socket.io.min.js') }}'><\/script>");
                }
                </script>
                <form action="/analytics" method="POST">
                    <input type="submit" value="analytics">
                </form>
                <form action="/forecast" method="POST">
                    <input type="submit" value="forecast">
                </form>
        {% endif %}
        <form action="/interface" method="POST">
            <input type="submit" value="interface">
        </form>
    </div>
    <script>
        $(document).ready(function () {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            const ctx = document.getElementById('myChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Parameter Data',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Timestamp' }},
                        y: { title: { display: true, text: 'Value' }}
                    }
                }
            });

            const plotParameters = ['temperature', 'humidity', 'altitude', 'barometer'];
            let data_buffer = JSON.parse('{{ data_buffer | tojson | safe }}');
            let currentParameter = $('#parameterSelect').val();

            function updateTable(data) {
                let tableBody = $('#dataTable tbody');
                tableBody.empty();
                for (const [key, value] of Object.entries(data)) {
                    tableBody.append(`<tr><td>${key}</td><td>${value}</td></tr>`);
                }
            }

            function updateChart(chart, data, label) {
                chart.data.labels.push(new Date().toLocaleTimeString());
                chart.data.datasets[0].label = label;
                chart.data.datasets[0].data.push(data);
                if (chart.data.labels.length > 10) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.update();
            }

            function resetChart(chart) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
            }

            function processDataBuffer() {
                if (data_buffer.length > 0) {
                    const latestData = data_buffer[data_buffer.length - 1];
                    updateTable(latestData);
                    const selectedParam = $('#parameterSelect').val();
                    if (selectedParam !== currentParameter) {
                        resetChart(chart);
                        currentParameter = selectedParam;
                    }
                    if (selectedParam && plotParameters.includes(selectedParam) && latestData[selectedParam]) {
                        updateChart(chart, parseFloat(latestData[selectedParam]), selectedParam);
                    }
                }
            }

            socket.on('update_data', function (data) {
                data_buffer.push(data);
                if (data_buffer.length > 10) {
                    data_buffer.shift();
                }
                processDataBuffer();
            });

            $('#parameterSelect').change(function () {
                processDataBuffer();
            });

            processDataBuffer();
        });
    </script>
{% endblock %}